---
import logo from "../../assets/logo.png";
import Menu from "./Menu.jsx";
interface Props { name: string; role: string }
const { name, role } = Astro.props as Props;
---
<header class="mx-auto w-full max-w-screen-2xl px-8 pt-6">
  <div class="flex items-start justify-between">
    <div class="flex items-start gap-3">
      <img transition:name="logo" src={logo.src} alt="Nova Forum" class="h-16 w-16" />
      <div class="flex flex-col leading-tight">
        <span class="font-semibold text-lg">Nova Forum</span>
        <span id="user-info" class="text-slate-600 text-sm">{name} ({role})</span>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <Menu client:load />
      
      <a id="logout-btn" href="#" class="inline-flex items-center justify-center rounded-full bg-[#7B1429] text-white px-6 py-3 font-semibold hover:scale-105 transition">Cerrar sesión</a>
    </div>
  </div>
</header>

<style is:global>
  html { scroll-behavior: smooth; }
  header nav a {
    display: inline-block;
    transition: transform 150ms ease, color 150ms ease;
  }
  header nav a:hover { transform: translateY(-2px); }
  .link-raise { transition: transform 150ms ease, color 150ms ease; }
  .link-raise:hover { transform: translateY(-2px); }
</style>

<script>
  const initNav = () => {
    try {
      const el = document.getElementById('user-info');
      if (!el) return;

      const roleMap = { 1: 'Administrador', 2: 'Investigador', 3: 'Revisor' } as Record<number, string>;

      const rawUser = localStorage.getItem('user');
      let firstName = '';
      let lastName = '';
      let roleNum: number | null = null;

      if (rawUser) {
        const user = JSON.parse(rawUser);
        firstName = user.First_name_user || user.Firs_name_user || user.first_name_user || user.firstName || user.first_name || user.name || '';
        lastName = user.Last_name_user || user.last_name_user || user.lastName || user.last_name || '';
        roleNum = Number(user.Num_rol);
      } else {
        const token = localStorage.getItem('token') || localStorage.getItem('jwt');
        if (token && token.split('.').length === 3) {
          const payload = JSON.parse(atob(token.split('.')[1]));
          firstName = payload.First_name_user || payload.Firs_name_user || payload.first_name_user || payload.firstName || payload.first_name || payload.name || '';
          lastName = payload.Last_name_user || payload.last_name_user || payload.lastName || payload.last_name || '';
          roleNum = Number(payload.Num_rol);
        }
      }

      const roleText = roleMap[Number(roleNum)] ?? (Number.isFinite(Number(roleNum)) ? String(roleNum) : 'Usuario');
      if (firstName) {
        el.textContent = `${firstName} ${lastName}`.trim() + ` (${roleText})`;
      }
      console.log('[NavBar] Rol detectado:', roleNum);
    } catch (e) {
      console.warn('[NavBar] Diagnóstico:', e);
    }
  };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNav);
  } else {
    initNav();
  }
  try {
    const btn = document.getElementById('logout-btn');
    if (btn) {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        localStorage.removeItem('user');
        localStorage.removeItem('token');
        localStorage.removeItem('jwt');
        window.location.href = '/landing';
      });
    }
  } catch {}
  </script>
